name: Manual Deploy

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œã®å‰ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’å®Ÿè¡Œè€…ã«ç¢ºèªã™ã‚‹!!
    inputs:
      environment:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒ"
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: "development"

      version:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
        required: false
        type: string
        default: "latest"

      skip_tests:
        description: "ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹"
        required: false
        type: boolean
        default: false

      log_level:
        description: "ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«"
        required: false
        type: choice
        options:
          - debug
          - info
          - warning
          - error
        default: "info"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å…¥åŠ›å€¤ã®è¡¨ç¤º
        run: |
          echo "ğŸ¯ ç’°å¢ƒ: ${{ inputs.environment }}"
          echo "ğŸ¯ ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼š ${{ vars.AWS_REGION }}"
          echo "ğŸ¯ ãƒã‚±ãƒƒãƒˆï¼š ${{ vars.AWS_S3_BUCKET }}"
          echo "ğŸ“¦ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ inputs.version }}"
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—: ${{ inputs.skip_tests }}"
          echo "ğŸ“ ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«: ${{ inputs.log_level }}"

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if: ${{ inputs.skip_tests == false }}
        run: npm test

      - name: ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          LOG_LEVEL: ${{ inputs.log_level }}

      #- uses: aws-actions/configure-aws-credentials@v4
      #  with:
      #    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #    aws-region: ${{ vars.AWS_REGION }}

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          echo "ğŸš€ ${{ inputs.environment }} ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
          # ã“ã“ã«å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
          aws s3 sync build/ s3://${{ vars.AWS_S3_BUCKET }}/

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
          echo "ç’°å¢ƒ: ${{ inputs.environment }}"
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ inputs.version }}"
